- onException:
    exception:
      - "org.apache.camel.CamelAuthorizationException"
    handled:
      constant: true
    steps:
      - setHeader:
          name: CamelHttpResponseCode
          constant: 403
      - setHeader:
          name: Content-Type
          constant: application/json
      - setBody:
          simple: '{"error": "Forbidden", "message": "Access denied", "timestamp": "${date:now:yyyy-MM-dd HH:mm:ss}"}'

- beans:
  - name: ordersReadPolicy
    type: org.apache.camel.component.keycloak.security.KeycloakSecurityPolicy
    properties:
      serverUrl: "{{keycloak.server.url}}"
      realm: "{{keycloak.realm}}"
      clientId: "{{keycloak.client.id}}"
      clientSecret: "{{keycloak.client.secret}}"
      requiredRoles: "orders-read"

  - name: ordersWritePolicy
    type: org.apache.camel.component.keycloak.security.KeycloakSecurityPolicy
    properties:
      serverUrl: "{{keycloak.server.url}}"
      realm: "{{keycloak.realm}}"
      clientId: "{{keycloak.client.id}}"
      clientSecret: "{{keycloak.client.secret}}"
      requiredRoles: "orders-write"

  - name: usersReadPolicy
    type: org.apache.camel.component.keycloak.security.KeycloakSecurityPolicy
    properties:
      serverUrl: "{{keycloak.server.url}}"
      realm: "{{keycloak.realm}}"
      clientId: "{{keycloak.client.id}}"
      clientSecret: "{{keycloak.client.secret}}"
      requiredRoles: "users-read"

  - name: adminPolicy
    type: org.apache.camel.component.keycloak.security.KeycloakSecurityPolicy
    properties:
      serverUrl: "{{keycloak.server.url}}"
      realm: "{{keycloak.realm}}"
      clientId: "{{keycloak.client.id}}"
      clientSecret: "{{keycloak.client.secret}}"
      requiredRoles: "api-admin"
      useTokenIntrospection: "{{keycloak.introspection.enabled}}"

- route:
    id: health
    from:
      uri: "platform-http:/api/health"
      steps:
        - setBody:
            simple: '{"status": "UP", "service": "api-gateway", "timestamp": "${date:now:yyyy-MM-dd HH:mm:ss}"}'
        - setHeader:
            name: Content-Type
            constant: application/json

- route:
    id: orders-collection
    from:
      uri: "platform-http:/api/orders"
      steps:
        - choice:
            when:
              - simple: "${header.CamelHttpMethod} == 'GET'"
                steps:
                  - policy:
                      ref: ordersReadPolicy
                  - setBody:
                      simple: '{"orders": [{"id": "ORD-001", "product": "Widget", "status": "shipped"}], "total": 1}'
              - simple: "${header.CamelHttpMethod} == 'POST'"
                steps:
                  - policy:
                      ref: ordersWritePolicy
                  - setBody:
                      simple: '{"id": "ORD-${date:now:yyyyMMddHHmmss}", "status": "created"}'
                  - setHeader:
                      name: CamelHttpResponseCode
                      constant: 201
        - setHeader:
            name: Content-Type
            constant: application/json

- route:
    id: users-collection
    from:
      uri: "platform-http:/api/users"
      steps:
        - policy:
            ref: usersReadPolicy
        - setBody:
            simple: '{"users": [{"id": "usr-001", "username": "john.doe"}], "total": 1}'
        - setHeader:
            name: Content-Type
            constant: application/json

- route:
    id: admin-stats
    from:
      uri: "platform-http:/api/admin/stats"
      steps:
        - policy:
            ref: adminPolicy
        - setBody:
            simple: '{"totalRequests": 15234, "activeUsers": 127, "systemHealth": "healthy"}'
        - setHeader:
            name: Content-Type
            constant: application/json
